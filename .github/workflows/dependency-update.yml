name: Dependency Update

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --global user.name "Dependabot Bot"
          git config --global user.email "dependabot@fluxolab.com"

      - name: Update root dependencies
        run: |
          npm update
          npm audit fix --force || true

      - name: Update backend dependencies
        run: |
          cd backend
          npm update
          npm audit fix --force || true

      - name: Update frontend dependencies
        run: |
          cd frontend
          npm update
          npm audit fix --force || true

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies"
          title: "üîÑ Dependency Update"
          body: |
            ## Dependency Update

            This PR updates all project dependencies to their latest versions.

            ### Updated packages:
            - Root dependencies
            - Backend dependencies (NestJS, etc.)
            - Frontend dependencies (Vue.js, Vite, etc.)

            ### Changes:
            - Updated package versions
            - Fixed security vulnerabilities
            - Updated lock files

            ### Testing:
            - [ ] All tests pass
            - [ ] No breaking changes detected
            - [ ] Security audit passes

            ---
            *This PR was automatically created by the Dependency Update workflow.*
          branch: dependency-update
          delete-branch: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Run security audit
        run: |
          npm audit --audit-level=moderate
          cd backend && npm audit --audit-level=moderate
          cd ../frontend && npm audit --audit-level=moderate

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=moderate

  outdated-check:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Check outdated dependencies
        run: |
          echo "## Root Dependencies" >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated dependencies" >> $GITHUB_STEP_SUMMARY
          
          echo "## Backend Dependencies" >> $GITHUB_STEP_SUMMARY
          cd backend && npm outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated dependencies" >> $GITHUB_STEP_SUMMARY
          
          echo "## Frontend Dependencies" >> $GITHUB_STEP_SUMMARY
          cd ../frontend && npm outdated >> $GITHUB_STEP_SUMMARY || echo "No outdated dependencies" >> $GITHUB_STEP_SUMMARY

  notify-security-issues:
    name: Notify Security Issues
    runs-on: ubuntu-latest
    needs: [security-audit]
    if: failure()
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#security'
          text: |
            ‚ö†Ô∏è Security Audit Failed
            
            The weekly security audit has failed. Please check the workflow logs for details.
            
            Workflow: ${{ github.workflow }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
