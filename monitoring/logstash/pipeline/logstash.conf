input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "fluxolab-backend" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:log_message}" }
    }
    
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    if [level] == "ERROR" {
      mutate {
        add_tag => [ "error" ]
      }
    }
    
    if [fields][type] == "request" {
      mutate {
        add_tag => [ "http_request" ]
      }
    }
    
    if [fields][type] == "auth" {
      mutate {
        add_tag => [ "authentication" ]
      }
    }
    
    if [fields][type] == "webhook" {
      mutate {
        add_tag => [ "webhook" ]
      }
    }
    
    if [fields][type] == "mcp" {
      mutate {
        add_tag => [ "mcp" ]
      }
    }
    
    if [fields][type] == "security" {
      mutate {
        add_tag => [ "security" ]
      }
    }
  }
}

output {
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "fluxolab-errors-%{+YYYY.MM.dd}"
    }
  }
  
  if "http_request" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "fluxolab-requests-%{+YYYY.MM.dd}"
    }
  }
  
  if "authentication" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "fluxolab-auth-%{+YYYY.MM.dd}"
    }
  }
  
  if "webhook" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "fluxolab-webhooks-%{+YYYY.MM.dd}"
    }
  }
  
  if "mcp" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "fluxolab-mcp-%{+YYYY.MM.dd}"
    }
  }
  
  if "security" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "fluxolab-security-%{+YYYY.MM.dd}"
    }
  }
  
  # Default output
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "fluxolab-logs-%{+YYYY.MM.dd}"
  }
}
